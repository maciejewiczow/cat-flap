name: Publish Docker image

on:
  release:
    types: [published]

jobs:
  push_to_registry:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        service:
          - name: diodes
          - name: hub
          - name: image-saver
          - name: inference
          - name: logger
          - name: logic
          - name: modvement-detector
          - name: servo
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@v5

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check for service-specific dockerfile
        id: has-dockerfile
        run: ls "${{matrix.service.name}}/Dockerfile"
        continue-on-error: true

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: mafciejewiczow/cat-flap-${{matrix.service.name}}-svc

      - name: Build the Docker image
        if: ${{ steps.has-dockerfile.outcome == 'failure' }}
        id: build-and-push-only
        uses: docker/build-push-action@v5
        with:
          context: .
          build-args: |
            APP_COPY_DIR="${{matrix.service.name}}"
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Generate artifact attestation
        if: ${{ steps.has-dockerfile.outcome == 'failure' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: mafciejewiczow/cat-flap-${{matrix.service.name}}-svc
          subject-digest: ${{ steps.build-and-push-only.outputs.digest }}
          push-to-registry: true

      - name: Build base Docker image
        if: ${{ steps.has-dockerfile.outcome == 'success' }}
        id: build-base-image
        uses: docker/build-push-action@v5
        with:
          context: .
          build-args: |
            APP_COPY_DIR="${{matrix.service.name}}"
          file: ./Dockerfile
          push: false
          labels: ${{matrix.service.name}}-base-app

      - name: Build service Docker image
        if: ${{ steps.has-dockerfile.outcome == 'success' }}
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{matrix.service.name}}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Generate artifact attestation
        if: ${{ steps.has-dockerfile.outcome == 'success' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: mafciejewiczow/cat-flap-${{matrix.service.name}}-svc
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true
